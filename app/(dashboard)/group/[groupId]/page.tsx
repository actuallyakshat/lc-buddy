import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import prisma from "@/db";
import { GroupWithMembershipsAndUsers } from "@/types/types";
import { currentUser } from "@clerk/nextjs/server";
import { MemberRole } from "@prisma/client";
import { Ellipsis } from "lucide-react";
import Link from "next/link";
import ChooseImageDialog from "./_components/ChooseImageDialog";
import DeleteGroupButton from "./_components/DeleteGroupButton";
import EditGroupButton from "./_components/EditGroupButton";
import AddFriendModal from "./_components/page";
import { getLeetcodeUserData } from "./_actions/leetcode-actions";
import { getSolvedQuestionsThisWeek } from "@/lib/utils";
import { WeeklySubmissionsChart } from "./_components/WeeklySubmissionsChart";
import { SubmissionsConrtibutionPieChart } from "./_components/SubmissionsConrtibutionPieChart";
import { DifficultyBifurcationBarChart } from "./_components/DifficultyBifurcationBarChart";

export default async function GroupPage({
  params,
}: {
  params: { groupId: string };
}) {
  const user = await currentUser();
  const id = params.groupId as string;
  const groupDetails = await prisma.group.findUnique({
    where: { id },
    include: {
      memberships: {
        include: { user: true },
      },
    },
  });

  const userInMembership = groupDetails?.memberships.find(
    (membership) => membership.user.id === user?.id,
  );

  if (!userInMembership) return <div>You are not a member of this group</div>;

  if (!groupDetails) return <div>Group not found</div>;

  const usersLeetcodeId = groupDetails.memberships.map((membership) => {
    return {
      id: membership.user.leetcodeId,
      name: membership.user.name,
    };
  });

  //TODO: Uncomment in production
  // const usersLeetcodeData = await getLeetcodeUserData(usersLeetcodeId);

  //DUMMY DATA TO WORK WITH
  const usersLeetcodeData = [
    {
      name: "akshat",
      status: "success",
      message: "retrieved",
      totalSolved: 233,
      totalQuestions: 3292,
      easySolved: 118,
      totalEasy: 826,
      mediumSolved: 104,
      totalMedium: 1721,
      hardSolved: 11,
      totalHard: 745,
      acceptanceRate: 72.28,
      ranking: 405922,
      contributionPoints: 657,
      reputation: 0,
      submissionCalendar: {
        "1694995200": 15,
        "1695081600": 14,
        "1695254400": 11,
        "1695340800": 9,
        "1695427200": 14,
        "1695513600": 8,
        "1695600000": 7,
        "1695686400": 1,
        "1695859200": 7,
        "1695945600": 4,
        "1696032000": 2,
        "1696118400": 14,
        "1696204800": 2,
        "1696464000": 1,
        "1696550400": 13,
        "1696636800": 3,
        "1696723200": 11,
        "1696809600": 7,
        "1696896000": 1,
        "1697241600": 4,
        "1697328000": 24,
        "1697414400": 1,
        "1697932800": 9,
        "1698537600": 11,
        "1698883200": 1,
        "1699056000": 3,
        "1699142400": 14,
        "1699488000": 2,
        "1699574400": 5,
        "1699747200": 5,
        "1700179200": 4,
        "1700352000": 2,
        "1700956800": 13,
        "1701216000": 7,
        "1701302400": 11,
        "1701388800": 3,
        "1701475200": 4,
        "1701561600": 7,
        "1701648000": 14,
        "1701734400": 4,
        "1701820800": 2,
        "1701907200": 12,
        "1701993600": 24,
        "1702080000": 31,
        "1702166400": 8,
        "1702252800": 7,
        "1702339200": 6,
        "1702425600": 4,
        "1702512000": 2,
        "1702598400": 2,
        "1702684800": 1,
        "1702771200": 3,
        "1702857600": 1,
        "1702944000": 1,
        "1703030400": 2,
        "1703116800": 4,
        "1703203200": 1,
        "1703289600": 4,
        "1703376000": 5,
        "1703462400": 2,
        "1703548800": 1,
        "1703635200": 2,
        "1703721600": 3,
        "1703808000": 3,
        "1703894400": 25,
        "1703980800": 4,
        "1704067200": 10,
        "1704153600": 16,
        "1704240000": 13,
        "1704326400": 16,
        "1704412800": 14,
        "1704499200": 5,
        "1704585600": 20,
        "1704672000": 10,
        "1704758400": 8,
        "1704844800": 20,
        "1704931200": 4,
        "1705017600": 3,
        "1705104000": 14,
        "1705190400": 1,
        "1705276800": 7,
        "1705363200": 2,
        "1705449600": 1,
        "1705536000": 3,
        "1705622400": 1,
        "1705708800": 10,
        "1705795200": 1,
        "1705881600": 3,
        "1705968000": 5,
        "1706054400": 1,
        "1706140800": 3,
        "1706227200": 1,
        "1706313600": 1,
        "1706400000": 1,
        "1706486400": 1,
        "1706572800": 1,
        "1706745600": 1,
        "1707004800": 1,
        "1707264000": 3,
        "1707350400": 1,
        "1707436800": 10,
        "1707523200": 7,
        "1707609600": 7,
        "1707696000": 2,
        "1707782400": 1,
        "1707955200": 1,
        "1708041600": 2,
        "1708128000": 8,
        "1708300800": 2,
        "1708387200": 4,
        "1708473600": 1,
        "1708560000": 1,
        "1708819200": 4,
        "1708905600": 5,
        "1709078400": 1,
        "1709251200": 1,
        "1710115200": 2,
        "1710201600": 1,
        "1710288000": 1,
        "1710374400": 3,
        "1710460800": 4,
        "1710547200": 3,
        "1710633600": 5,
        "1710720000": 4,
        "1710806400": 1,
        "1710892800": 1,
        "1710979200": 1,
        "1711065600": 1,
        "1711152000": 1,
        "1711238400": 1,
        "1711324800": 1,
        "1711411200": 1,
        "1711497600": 2,
        "1711584000": 1,
        "1711670400": 1,
        "1711756800": 1,
        "1711843200": 1,
        "1711929600": 1,
        "1712016000": 1,
        "1712102400": 1,
        "1712188800": 1,
        "1712361600": 1,
        "1712448000": 1,
        "1712534400": 1,
        "1712620800": 9,
        "1712707200": 2,
        "1712793600": 1,
        "1712880000": 1,
        "1713312000": 1,
        "1713398400": 1,
        "1714521600": 1,
        "1714608000": 4,
        "1716595200": 3,
        "1716681600": 1,
        "1716768000": 3,
        "1716854400": 4,
        "1716940800": 10,
        "1717027200": 6,
        "1717113600": 9,
        "1717200000": 8,
        "1717286400": 8,
        "1717372800": 2,
        "1717459200": 6,
        "1717545600": 1,
        "1717632000": 4,
        "1717718400": 2,
        "1717804800": 11,
        "1717891200": 2,
        "1717977600": 3,
        "1718064000": 2,
        "1718150400": 1,
        "1718236800": 2,
        "1718323200": 2,
        "1718409600": 1,
        "1718496000": 1,
        "1718582400": 8,
        "1718668800": 2,
        "1718755200": 3,
        "1718841600": 1,
        "1718928000": 8,
        "1719014400": 1,
        "1719100800": 1,
        "1719187200": 9,
        "1719273600": 4,
        "1719360000": 1,
        "1719446400": 1,
        "1719532800": 3,
        "1719619200": 2,
        "1719705600": 1,
        "1719792000": 5,
        "1719878400": 1,
        "1719964800": 6,
        "1720051200": 2,
        "1720137600": 1,
        "1720224000": 1,
        "1720310400": 2,
        "1720396800": 8,
        "1720483200": 1,
        "1720569600": 5,
        "1720656000": 1,
        "1720742400": 2,
        "1720828800": 1,
        "1720915200": 3,
        "1721001600": 3,
        "1721088000": 1,
        "1721174400": 1,
        "1721260800": 5,
        "1721347200": 3,
        "1721692800": 1,
        "1721865600": 1,
        "1722211200": 3,
        "1722297600": 10,
        "1722470400": 1,
        "1722643200": 4,
        "1722729600": 2,
        "1722816000": 3,
        "1722902400": 1,
        "1723334400": 3,
        "1723420800": 1,
        "1723507200": 3,
        "1723593600": 2,
        "1723680000": 5,
        "1723766400": 1,
        "1723852800": 3,
        "1723939200": 3,
        "1724112000": 3,
        "1724284800": 3,
        "1724544000": 5,
        "1724630400": 1,
        "1724716800": 1,
        "1725062400": 1,
        "1725235200": 1,
        "1725321600": 2,
        "1725494400": 15,
        "1725580800": 12,
        "1725667200": 11,
        "1725753600": 7,
        "1725840000": 14,
        "1725926400": 3,
        "1726012800": 1,
        "1726099200": 1,
        "1726185600": 2,
        "1726272000": 5,
        "1726358400": 1,
        "1726531200": 12,
      },
    },
    {
      name: "nehal",
      status: "success",
      message: "retrieved",
      totalSolved: 466,
      totalQuestions: 3292,
      easySolved: 207,
      totalEasy: 826,
      mediumSolved: 229,
      totalMedium: 1721,
      hardSolved: 30,
      totalHard: 745,
      acceptanceRate: 58.22,
      ranking: 130195,
      contributionPoints: 2907,
      reputation: 0,
      submissionCalendar: {
        "1694995200": 15,
        "1695081600": 14,
        "1695254400": 11,
        "1695340800": 9,
        "1695427200": 14,
        "1695513600": 8,
        "1695600000": 7,
        "1695686400": 1,
        "1695859200": 7,
        "1695945600": 4,
        "1696032000": 2,
        "1696118400": 14,
        "1696204800": 2,
        "1696464000": 1,
        "1696550400": 13,
        "1696636800": 3,
        "1696723200": 11,
        "1696809600": 7,
        "1696896000": 1,
        "1697241600": 4,
        "1697328000": 24,
        "1697414400": 1,
        "1697932800": 9,
        "1698537600": 11,
        "1698883200": 1,
        "1699056000": 3,
        "1699142400": 14,
        "1699488000": 2,
        "1699574400": 5,
        "1699747200": 5,
        "1700179200": 4,
        "1700352000": 2,
        "1700956800": 13,
        "1701216000": 7,
        "1701302400": 11,
        "1701388800": 3,
        "1701475200": 4,
        "1701561600": 7,
        "1701648000": 14,
        "1701734400": 4,
        "1701820800": 2,
        "1701907200": 12,
        "1701993600": 24,
        "1702080000": 31,
        "1702166400": 8,
        "1702252800": 7,
        "1702339200": 6,
        "1702425600": 4,
        "1702512000": 2,
        "1702598400": 2,
        "1702684800": 1,
        "1702771200": 3,
        "1702857600": 1,
        "1702944000": 1,
        "1703030400": 2,
        "1703116800": 4,
        "1703203200": 1,
        "1703289600": 4,
        "1703376000": 5,
        "1703462400": 2,
        "1703548800": 1,
        "1703635200": 2,
        "1703721600": 3,
        "1703808000": 3,
        "1703894400": 25,
        "1703980800": 4,
        "1704067200": 10,
        "1704153600": 16,
        "1704240000": 13,
        "1704326400": 16,
        "1704412800": 14,
        "1704499200": 5,
        "1704585600": 20,
        "1704672000": 10,
        "1704758400": 8,
        "1704844800": 20,
        "1704931200": 4,
        "1705017600": 3,
        "1705104000": 14,
        "1705190400": 1,
        "1705276800": 7,
        "1705363200": 2,
        "1705449600": 1,
        "1705536000": 3,
        "1705622400": 1,
        "1705708800": 10,
        "1705795200": 1,
        "1705881600": 3,
        "1705968000": 5,
        "1706054400": 1,
        "1706140800": 3,
        "1706227200": 1,
        "1706313600": 1,
        "1706400000": 1,
        "1706486400": 1,
        "1706572800": 1,
        "1706745600": 1,
        "1707004800": 1,
        "1707264000": 3,
        "1707350400": 1,
        "1707436800": 10,
        "1707523200": 7,
        "1707609600": 7,
        "1707696000": 2,
        "1707782400": 1,
        "1707955200": 1,
        "1708041600": 2,
        "1708128000": 8,
        "1708300800": 2,
        "1708387200": 4,
        "1708473600": 1,
        "1708560000": 1,
        "1708819200": 4,
        "1708905600": 5,
        "1709078400": 1,
        "1709251200": 1,
        "1710115200": 2,
        "1710201600": 1,
        "1710288000": 1,
        "1710374400": 3,
        "1710460800": 4,
        "1710547200": 3,
        "1710633600": 5,
        "1710720000": 4,
        "1710806400": 1,
        "1710892800": 1,
        "1710979200": 1,
        "1711065600": 1,
        "1711152000": 1,
        "1711238400": 1,
        "1711324800": 1,
        "1711411200": 1,
        "1711497600": 2,
        "1711584000": 1,
        "1711670400": 1,
        "1711756800": 1,
        "1711843200": 1,
        "1711929600": 1,
        "1712016000": 1,
        "1712102400": 1,
        "1712188800": 1,
        "1712361600": 1,
        "1712448000": 1,
        "1712534400": 1,
        "1712620800": 9,
        "1712707200": 2,
        "1712793600": 1,
        "1712880000": 1,
        "1713312000": 1,
        "1713398400": 1,
        "1714521600": 1,
        "1714608000": 4,
        "1716595200": 3,
        "1716681600": 1,
        "1716768000": 3,
        "1716854400": 4,
        "1716940800": 10,
        "1717027200": 6,
        "1717113600": 9,
        "1717200000": 8,
        "1717286400": 8,
        "1717372800": 2,
        "1717459200": 6,
        "1717545600": 1,
        "1717632000": 4,
        "1717718400": 2,
        "1717804800": 11,
        "1717891200": 2,
        "1717977600": 3,
        "1718064000": 2,
        "1718150400": 1,
        "1718236800": 2,
        "1718323200": 2,
        "1718409600": 1,
        "1718496000": 1,
        "1718582400": 8,
        "1718668800": 2,
        "1718755200": 3,
        "1718841600": 1,
        "1718928000": 8,
        "1719014400": 1,
        "1719100800": 1,
        "1719187200": 9,
        "1719273600": 4,
        "1719360000": 1,
        "1719446400": 1,
        "1719532800": 3,
        "1719619200": 2,
        "1719705600": 1,
        "1719792000": 5,
        "1719878400": 1,
        "1719964800": 6,
        "1720051200": 2,
        "1720137600": 1,
        "1720224000": 1,
        "1720310400": 2,
        "1720396800": 8,
        "1720483200": 1,
        "1720569600": 5,
        "1720656000": 1,
        "1720742400": 2,
        "1720828800": 1,
        "1720915200": 3,
        "1721001600": 3,
        "1721088000": 1,
        "1721174400": 1,
        "1721260800": 5,
        "1721347200": 3,
        "1721692800": 1,
        "1721865600": 1,
        "1722211200": 3,
        "1722297600": 10,
        "1722470400": 1,
        "1722643200": 4,
        "1722729600": 2,
        "1722816000": 3,
        "1722902400": 1,
        "1723334400": 3,
        "1723420800": 1,
        "1723507200": 3,
        "1723593600": 2,
        "1723680000": 5,
        "1723766400": 1,
        "1723852800": 3,
        "1723939200": 3,
        "1724112000": 3,
        "1724284800": 3,
        "1724544000": 5,
        "1724630400": 1,
        "1724716800": 1,
        "1725062400": 1,
        "1725235200": 1,
        "1725321600": 2,
        "1725494400": 15,
        "1725580800": 12,
        "1725667200": 11,
        "1725753600": 7,
        "1725840000": 14,
        "1725926400": 3,
        "1726012800": 1,
        "1726099200": 1,
        "1726185600": 2,
        "1726272000": 5,
        "1726358400": 1,
        "1726531200": 5,
      },
    },
  ];

  const solvedThisWeek = usersLeetcodeData.map((data) =>
    getSolvedQuestionsThisWeek(data.submissionCalendar, data.name),
  );

  return (
    <div className="thin-scrollbar pb-12">
      <div
        className={`group relative min-h-[300px] w-full ${
          groupDetails?.headerImageURL ? "group-header-image" : ""
        } bg-zinc-300`}
        style={
          groupDetails?.headerImageURL
            ? { backgroundImage: `url('${groupDetails.headerImageURL}')` }
            : {}
        }
      >
        <ChooseImageDialog groupId={id} />
      </div>
      <div className="page thin-scrollbar">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold md:text-3xl">
              {groupDetails?.name}
            </h2>
            <p className="text-sm font-medium text-muted-foreground">
              {groupDetails?.description}
            </p>
          </div>
          <div className="flex items-center gap-2">
            <OptionsMenu
              id={id}
              groupDetails={groupDetails}
              role={userInMembership.role}
            />
          </div>
        </div>
        <WeeklySubmissionsChart data={solvedThisWeek} />
        <div className="grid w-full grid-cols-1 gap-4 xl:grid-cols-2">
          <DifficultyBifurcationBarChart data={usersLeetcodeData} />
          <SubmissionsConrtibutionPieChart data={solvedThisWeek} />
        </div>
      </div>
    </div>
  );
}

function OptionsMenu({
  id,
  role,
  groupDetails,
}: {
  id: string;
  role: MemberRole;
  groupDetails: GroupWithMembershipsAndUsers;
}) {
  return (
    <DropdownMenu modal={false}>
      <DropdownMenuTrigger>
        <Ellipsis />
      </DropdownMenuTrigger>
      <DropdownMenuContent className="mr-10 text-left hover:bg-none">
        <DropdownMenuLabel>Group Options</DropdownMenuLabel>
        <DropdownMenuSeparator />
        <DropdownMenuItem>
          <Link href={`/group/${id}/members`} className="w-full">
            View Members
          </Link>
        </DropdownMenuItem>
        {role === MemberRole.ADMIN && (
          <div>
            <DropdownMenuItem asChild>
              <AddFriendModal groupId={id} />
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <EditGroupButton groupId={id} groupDetails={groupDetails} />
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <DeleteGroupButton groupId={id} />
            </DropdownMenuItem>
          </div>
        )}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
